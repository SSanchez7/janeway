{% extends "admin/core/base.html" %}
{% load foundation %}
{% load files %}
{% load i18n %}

{% block title %}Revision for {{ revision_request.article.title }}{% endblock title %}
{% block title-section %}Revision for {{ revision_request.article.safe_title }}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    {% include "elements/breadcrumbs/review_base.html" with subpage="yes" %}
    <li>Revisions for {{ revision_request.article.safe_title }}</li>
{% endblock breadcrumbs %}

{% block body %}
    <div class="large-12 columns">
        <div class="box">
            <div class="title-area">
                <h2>1. Information</h2>
            </div>
            <div class="content">
                <div class="callout primary">
                    <p><span class="fa fa-info-circle"></span>&nbsp;
                        {% blocktrans %}
                        You have been asked to revise your article manuscript. If the editor has made peer review comments
                        available for you to view, these will be visible below. The manuscript and any additional files are
                        also listed below.
                        {% endblocktrans %}
                    </p>
                </div>
                <p>
                    The editor, <b>{{ revision_request.editor.full_name }}</b>, supplied the following note:
                </p>
                <table class="scroll">
                    <tr><td colspan="4">
                        {% if revision_request.editor_note %}
                            {{ revision_request.editor_note|safe }}
                        {% else %}
                            No Information
                        {% endif %}
                    </td></tr>
                </table>
                <br/>
            </div>
            {% if reviews %}
            <div class="title-area">
                <h2>2. Reviews</h2>
            </div>
            <div class="content">
                {% include "admin/elements/review/view_reviews.html" %}
            </div>
            {% endif %}
            <form method="POST" id="do_revision">
                {% csrf_token %}
                <div class="title-area">
                    <h2>{% if reviews %}3.{% else %}2.{% endif %}Files</h2>
                </div>
                <div class="content">
                    <div class="callout primary">
                        <p><span class="fa fa-info-circle"></span>&nbsp;
                        Your article files are listed below. You can use the <b>Upload Revised File</b> button next to each
                        file to upload a new version of the file, or use the <b>Upload New File</b> button to upload a new
                        file.</p>
                    </div>
                    <a href="{% url 'revisions_upload_new_file' article.pk revision_request.pk %}"
                       class="button"><i class="fa fa-upload">&nbsp;</i>Upload New File</a>
                    <table class="scroll small">
                        <tr>
                            <th>Label</th>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Uploaded</th>
                            <th>Size</th>
                            <th>Download</th>
                            <th>Upload Revised File</th>
                            <th>Delete</th>
                        </tr>
                        {% for file in article.manuscript_files.all %}
                            <tr>
                                <td>{{ file.label }}</td>
                                <td>{{ file.original_filename }}</td>
                                <td>Manuscript</td>
                                <td>{{ file.date_uploaded|date:"Y-m-d G:i" }}</td>
                                <td>{% file_size file article %}</td>
                                <td><a href="?file_id={{ file.id }}"><i class="fa fa-download">&nbsp;</i></a></td>
                                <td><a href="{% url 'revisions_replace_file' article.pk revision_request.pk file.pk %}"><i
                                        class="fa fa-cloud-upload">&nbsp;</i></a></td>
                                <td>
                                    <button type="submit" name="delete" value="{{ file.id }}"
                                            onclick="return confirm('Are you sure you want to delete this item?');"><i
                                            class="fa fa-trash"></i></button>
                                </td>
                            </tr>
                        {% endfor %}
                        {% for file in article.data_figure_files.all %}
                            <tr>
                                <td>{{ file.label }}</td>
                                <td>{{ file.original_filename }}</td>
                                <td>Data/Figure</td>
                                <td>{{ file.date_uploaded|date:"Y-m-d G:i" }}</td>
                                <td>{% file_size file article %}</td>
                                <td><a href="?file_id={{ file.id }}"><i class="fa fa-download">&nbsp;</i></a></td>
                                <td><a href="{% url 'revisions_replace_file' article.pk revision_request.pk file.pk %}"><i
                                        class="fa fa-cloud-upload">&nbsp;</i></a></td>
                                <td>
                                    <button type="submit" name="delete" value="{{ file.id }}"
                                            onclick="return confirm('Are you sure you want to delete this item?');"><i
                                            class="fa fa-trash"></i></button>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="title-area">
                    <h2>{% if reviews %}4.{% else %}3.{% endif %} Responses</h2>
                </div>
                <div class="content">
                    <div class="callout primary">
                        <p><span class="fa fa-info-circle"></span>&nbsp;
                            In this section you can add a covering letter for the 
                            editor and a response letter that will be shared with the reviewers.
                            You can also upload the response letter as an attached file using 
                            the <b>Upload Response Letter</b> button.
                        </p>
                        <p>If you want to save your responses and
                            come back later, click the <b>Save Responses</b>
                            button below. Once you are ready to
                            send your letters, see the <b>Finishing Up</b>
                            section below.
                        </p>
                    </div>
                    {% include "elements/forms/errors.html" with form=form %}
                    {% include "elements/revision_response_letter.html" %}
                    <div class="row expanded">
                        <div class="large-6 medium-12 columns">
                            {{ form.author_note|foundation }}
                        </div>
                        <div class="large-6 medium-12 columns">
                            {{ form.response_letter|foundation }}
                        </div>
                    </div>

                    <button class="button success" name="save">
                        Save Responses
                    </button>
                </div>
                <div class="title-area">
                    <h2>{% if reviews %}5.{% else %}4.{% endif %}Finishing Up</h2>
                </div>
                <div class="content">
                    <div class="callout primary">
                        <p><span class="fa fa-info-circle"></span>&nbsp;
                        {% trans "When you have completed your revisions and finished writing your covering letter, click the <b>Submit Revisions</b> button below to finish. Please note that you will not be able to make any further changes to your letter or revisions once you click <b>Submit Revisions</b>" %}</p>
                    </div>
                    <button class="button success" name="{{ form.CONFIRMABLE_BUTTON_NAME }}">Submit Revisions</button>
                </div>
            </form>
        </div>
    </div>

    {% if form.modal %}
        {% include "admin/elements/confirm_modal.html" with modal=form.modal form_id="do_revision" %}
    {% endif %}

{% endblock body %}

{% block js %}
    {% if form.modal %}
        {% include "admin/elements/open_modal.html" with target=form.modal.id %}
    {% endif %}
{% endblock js %}
